<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hệ thống Kiểm tra Online 2025</title>
</head>
<body>
  <h1>Hệ thống Kiểm tra Online</h1>
  <p>Nhập thông tin để đăng ký:</p>
  <form id="regForm">
    <label>Họ và tên:</label><input id="r_fullname"><br>
    <label>Ngày sinh:</label><input id="r_birth"><br>
    <label>Giới tính:</label><input id="r_gender"><br>
    <label>Dân tộc:</label><input id="r_ethnicity"><br>
    <label>Trường:</label><input id="r_school"><br>
    <label>Khối:</label><input id="r_grade"><br>
    <label>Mã lớp:</label><input id="r_class"><br>
    <label>Số CCCD:</label><input id="r_cccd"><br>
    <label>Email:</label><input id="r_email"><br>
    <label>Ghi chú:</label><input id="r_note"><br>
    <button type="button" id="btnRegister">Gửi đăng ký</button>
    <p id="msgReg"></p>
  </form>

<script>
const API_DEFAULT = 'https://solitary-leaf-24bd.nvtpvd.workers.dev'; // Worker cố định

const gid = id => document.getElementById(id);
function valAny(...ids) {
  for (const id of ids) {
    const el = gid(id);
    if (el && typeof el.value === 'string') return el.value.trim();
  }
  return '';
}
function msg(id, text, isErr=false, isOk=false){
  const el = gid(id);
  if (!el) return;
  el.textContent = text;
  el.style.color = isErr ? 'red' : (isOk ? 'green' : 'black');
}

function normalizeFullName(str){
  return String(str||'').normalize('NFC').trim().replace(/\s+/g,' ').toUpperCase();
}

async function api(action, body = {}) {
  try {
    const res = await fetch(API_DEFAULT, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({action, ...body})
    });
    return await res.json();
  } catch(e) {
    return {ok:false, reason:'Không kết nối được máy chủ'};
  }
}

async function onRegister(){
  const fullname = normalizeFullName(valAny('r_fullname','fullname','hoten'));
  const payload = {
    fullname,
    birth: valAny('r_birth'),
    gender: valAny('r_gender'),
    ethnicity: valAny('r_ethnicity'),
    school: valAny('r_school'),
    grade: valAny('r_grade'),
    classCode: valAny('r_class'),
    cccd: valAny('r_cccd'),
    email: valAny('r_email'),
    note: valAny('r_note')
  };

  const btn = gid('btnRegister'); if(btn) btn.disabled = true;
  msg('msgReg','Đang gửi đăng ký...');
  const res = await api('register', {payload});
  if(btn) btn.disabled = false;
  if(res.ok) msg('msgReg','✅ Đăng ký thành công', false, true);
  else msg('msgReg','❌ Lỗi: '+res.reason, true, false);
}

gid('btnRegister').onclick = onRegister;
</script>
</body>
</html>
