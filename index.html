<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Hệ thống Kiểm tra Online</title>
<style>
  :root{
    --bg:#0d6efd; --txt:#111; --muted:#6b7280; --ok:#16a34a; --err:#dc2626; --card:#fff;
    --bd:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f6f8fb;color:var(--txt)}
  header{background:var(--bg);color:#fff;padding:20px 16px}
  header h1{margin:0;font-size:22px;font-weight:800}
  .wrap{max-width:980px;margin:18px auto;padding:0 16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media(max-width:720px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
  .card h2{margin:0 0 12px;font-size:18px}
  .pad{padding:20px}
  label{display:block;font-weight:600;margin:8px 0 6px}
  input,select,textarea{
    width:100%;padding:12px 14px;border:1px solid var(--bd);border-radius:12px;background:#fff;
    font:inherit;outline:0;
  }
  input:focus,select:focus,textarea:focus{border-color:#9ac3ff;box-shadow:0 0 0 3px #cfe3ff}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .btn{
    padding:11px 16px;border-radius:12px;border:1px solid transparent;background:var(--bg);color:#fff;
    cursor:pointer;font-weight:700
  }
  .btn.ghost{background:#fff;color:#111;border-color:var(--bd)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .muted{color:var(--muted);font-size:13px;margin-top:4px}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;margin-top:8px}
  .ok{background:#ecfdf5;color:var(--ok);border:1px solid #bbf7d0}
  .err{background:#fef2f2;color:var(--err);border:1px solid #fecaca}
  footer{padding:18px 16px;color:var(--muted);text-align:center}
</style>
</head>
<body>
<header><h1>Hệ thống Kiểm tra Online</h1></header>
<div class="wrap grid">
  <section class="card pad">
    <h2>Đăng ký tài khoản</h2>
    <label>Họ và tên</label>
    <input id="r_fullname" placeholder="Ví dụ: Nguyễn Văn A">
    <label>Ngày sinh</label>
    <input id="r_birth" placeholder="YYYY-MM-DD">
    <label>Giới tính</label>
    <input id="r_gender" placeholder="Nam/Nữ">
    <label>Dân tộc</label>
    <input id="r_ethnicity" placeholder="Kinh, Hoa, ...">
    <label>Trường</label>
    <input id="r_school" placeholder="VD: THPT Nguyễn Đình Chiểu">
    <label>Khối</label>
    <input id="r_grade" placeholder="10, 11, 12">
    <label>Mã lớp</label>
    <input id="r_class" placeholder="VD: 12A1">
    <label>Số CCCD</label>
    <input id="r_cccd" placeholder="12 số">
    <label>Email</label>
    <input id="r_email" placeholder="name@email.com">
    <label>Ghi chú</label>
    <textarea id="r_note" rows="2" placeholder="Tùy chọn"></textarea>
    <div class="btns">
      <button class="btn" id="btnRegister">Gửi đăng ký</button>
      <button class="btn ghost" id="btnPing">Kiểm tra kết nối</button>
    </div>
    <div id="msgReg" class="pill" style="display:none"></div>
  </section>
  <aside class="card pad">
    <h2>Trạng thái hệ thống</h2>
    <div id="statusBox" class="pill" style="display:none"></div>
  </aside>
</div>
<footer>© THPT Nguyễn Đình Chiểu – Hệ thống kiểm tra Online</footer>

<script>
  const API_DEFAULT = 'https://solitary-leaf-24bd.nvtpvd.workers.dev';
  const gid = id => document.getElementById(id);
  const show = (el, yes=true) => (el.style.display = yes ? '' : 'none');

  function toast(el, text, type='ok'){
    el.className = 'pill ' + (type==='ok'?'ok':'err');
    el.textContent = text;
    show(el,true);
  }

  function normalizeFullName(s){
    return String(s||'').normalize('NFC').trim().replace(/\s+/g,' ').toUpperCase();
  }

  async function api(action, body={}){
    try{
      const r = await fetch(API_DEFAULT, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({action, ...body})
      });
      return await r.json();
    }catch(e){
      return {ok:false, reason:'Không kết nối được máy chủ'};
    }
  }

  async function onRegister(){
    const btn = gid('btnRegister'); btn.disabled = true;
    const msg = gid('msgReg');

    const payload = {
      fullname: normalizeFullName(gid('r_fullname').value),
      birth: gid('r_birth').value.trim(),
      gender: gid('r_gender').value.trim(),
      ethnicity: gid('r_ethnicity').value.trim(),
      school: gid('r_school').value.trim(),
      grade: gid('r_grade').value.trim(),
      classCode: gid('r_class').value.trim(),
      cccd: gid('r_cccd').value.trim(),
      email: gid('r_email').value.trim(),
      note: gid('r_note').value.trim()
    };

    toast(msg,'Đang gửi đăng ký...','ok');
    const res = await api('register',{payload});
    btn.disabled = false;

    if(res.ok) toast(msg,'Đăng ký thành công ✔','ok');
    else toast(msg,'Lỗi: '+(res.reason||'Không xác định'),'err');
  }

  async function ping(){
    const box = gid('statusBox');
    show(box,false);
    try{
      const url = API_DEFAULT+'?action=pingSheet';
      const r = await fetch(url);
      const t = await r.text();
      if(r.ok && /"ok"\s*:\s*true/.test(t)) toast(box,'Kết nối OK (Worker ↔ Apps Script)','ok');
      else toast(box,'Worker hoạt động nhưng Apps Script lỗi','err');
    }catch(e){
      toast(box,'Không truy cập được Worker','err');
    }
  }

  gid('btnRegister').onclick = onRegister;
  gid('btnPing').onclick = ping;
</script>
</body>
</html>
